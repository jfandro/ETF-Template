
@{
    ViewBag.Title = "Operations";
}
<link href="~/Content/mydataviz.css" rel="stylesheet" />
<style>
    .img-td {
        width: 16px;
        height: 16px;
        border: 1px solid #ccc;
    }
</style>

@section header {
    <section class="jumbotron section-header header-image" style="background-image:url('https://www.letelegramme.fr/images/2019/03/25/oceans-un-bien-commun-de-l-humanite-a-defendre-a-l-onu_4484351_540x271p.jpg')">
        <div class="container">
            <h1 class="text-center">Activité</h1>
            <p class="lead text-center">Suivez vos opérations et vos résultats</p>
        </div>
    </section>
}

<section class="section-b">
    <div class="container">
        <p>
            Sur cette page, nous allons nous intéresser à l'historique opérationnelle (arbitrages) d'un portefeuille,
            ainsi qu'aux résultats réalisés lors des éventuelles cessions opérées. Nous ferons comme sur les autres pages, à savoir la séparation
            entre <b>la phase de collecte des données</b> et celle qui de restitution des dites données dans des tableaux ou autres widgets filtrants.
        </p>
        <p>
            On commencera par une phase préliminaire identique aux autres expériences. 
            Vous pouvez remplacer cette saisie en clef par une saisie avec une liste déroulante.
        </p>
        <p>
            Nous avons choisi de restituer l'activité d'un portefeuille via un tableau (ci-dessous) et 5 graphiques dont l'objet est de montrer
            les périodes d'arbitrage sur une échelle temps, quelles classes d'actif et quelle sociétés de gestion ont été retenu dans la stratégie. L'autre fonction de ces graphiques est
            de servir de filtres interactifs de manière à concenter l'information affichée sur une partie de cette activité. Cliquez sur un segment
            ou une barre et vous mettrez à jour les autres graphique ainsi que le tableau détaillé.
        </p>
        <p>
            Les camemberts permettent quand à eux de se focaliser sur les achats ou les ventes, les deals gagnants ou perdant au regard des prix actuels
            de marché.
        </p>
    </div>
</section>

<section class="section-d">
    <div class="container">
        <h2>Activité mensuelle</h2>
        <p>Indiquez le portefeuille OU laissez cette zone vide pour afficher l'activité de tous les portefeuilles modèles
        que vous gérez et suivez. Le nom du portefeuille apparaitra dans le tableau.</p>
        <div class="form-inline  text-center">
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">Portefeuille</div>
                    <select id="PositionCode" name="code" class="form-control select-portfolios">
                        <option value="">Tous</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary btn-activity">Afficher</button>
            </div>
        </div>
    </div>
    <div class="container" style="margin-top:80px;">
        <div class="row">
            <div class="col-xs-12 dc-panel">
                <div class="btn-group btn-group-xs btn-select" data-toggle="buttons" data-chart="#history">
                    <label class="btn btn-primary active" data-value="count"><input type=radio name="class">Nombre</label>
                    <label class="btn btn-primary" data-value="aweight"><input type=radio name="class">Poids</label>
                    <label class="btn btn-primary" data-value="netreturn"><input type=radio name="class">Performance</label>
                </div>
                <div id="history" class="activity-chart bar-chart" data-chart="bars" data-dimension="dd" data-time="month" data-value="count" style="height:200px;">
                    <a class="reset" href="javascript:$x.reset('#history');" style="display: none;"><i class="fa fa-undo"></i></a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-5 col-sm-6 dc-panel">
                <h3>Distribution par classe d'actifs</h3>
                <div class="btn-group btn-group-xs btn-select" data-toggle="buttons" data-chart="#classes">
                    <label class="btn btn-primary" data-value="count"><input type=radio name="class">Nombre</label>
                    <label class="btn btn-primary active" data-value="weight"><input type=radio name="class">Poids</label>
                    <label class="btn btn-primary" data-value="netreturn"><input type=radio name="class">Performance</label>
                    <label class="btn btn-primary" data-value="contrib"><input type=radio name="class">Contribution</label>
                </div>
                <div id="classes" class="activity-chart row-chart" data-chart="rows" data-dimension="category" data-value="weight" style="height:460px;">
                    <a class="reset" href="javascript:$x.reset('#classes');" style="display: none;"><i class="fa fa-undo"></i></a>
                </div>
            </div>
            <div class="col-md-5 col-sm-6 dc-panel">
                <h3>Distribution par société de gestion</h3>
                <div class="btn-group btn-group-xs btn-select" data-toggle="buttons" data-chart="#issuers">
                    <label class="btn btn-primary" data-value="count"><input type=radio name="issuer">Nombre</label>
                    <label class="btn btn-primary active" data-value="weight"><input type=radio name="issuer">Poids</label>
                    <label class="btn btn-primary" data-value="netreturn"><input type=radio name="issuer">Performance</label>
                    <label class="btn btn-primary" data-value="contrib"><input type=radio name="issuer">Contribution</label>
                </div>
                <div id="issuers" class="activity-chart row-chart" data-chart="rows" data-dimension="issuer" data-value="weight" style="height:460px;">
                    <a class="reset" href="javascript:$x.reset('#issuers');" style="display: none;"><i class="fa fa-undo"></i></a>
                </div>
            </div>
            <div class="col-md-2 col-sm-8 col-md-offset-0 col-sm-offset-2">
                <div class="row">
                    <div class="col-md-12 dc-panel">
                        <h3 class="text-center small">Achats/ventes</h3>
                        <div id="distribution" class="activity-chart pie-chart" data-chart="pie" data-dimension="type" style="height:120px;">
                            <a class="reset" href="javascript:$x.reset('#distribution');" style="display: none;"><i class="fa fa-undo"></i></a>
                        </div>
                    </div>
                    <div class="col-md-12 dc-panel">
                        <h3 class="text-center small">Gagnants/perdants</h3>
                        <div id="pnl" class="activity-chart pie-chart" data-chart="pie" data-dimension="pl" style="height:120px;">
                            <a class="reset" href="javascript:$x.reset('#pnl');" style="display: none;"><i class="fa fa-undo"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<section class="section-e">
    <div class="container">
        <h2>Journal des opérations et des résultats</h2>
        <p>
            Ce tableau reflète l'activité du portefeuille et son contenu est filtré en fonction des éléments sélectionnés sur les
            widgets précédent. Son contenu est personnalisable en terme de données, de format, de liens de redirection et de tri.
        </p>
        <div class="table-responsive">
            <table id="operations-table" class="activity-chart table table-hover table-condensed small" data-chart="table" data-page-size="20" data-table="model">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Model</th>
                        <th></th>
                        <th>ETF</th>
                        <th>Emetteur</th>
                        <th class="text-center">Prix</th>
                        <th class="text-center">Poids</th>
                        <th class="text-center">PnL</th>
                        <th class="text-center">Contribution</th>
                    </tr>
                </thead>
            </table>
        </div>

        <div id="paging">
            Showing <span id="begin"></span>-<span id="end"></span> of <span id="size"></span>.
            <input id="last" class="btn btn-sm" type="button" value="Last" onclick="javascript: $x.widget('#operations-table').last()" />
            <input id="next" class="btn btn-sm" type="button" value="Next" onclick="javascript: $x.widget('#operations-table').next()" />
        </div>
    </div>
</section>


<section class="section-d">
    <div class="container">
        <h2>Arbitrage</h2>
        <p>Dernière étape de cette expérience, nous vous proposons d'enregistrer un arbitrage. 
        Indiquez la date, l'instrument concerné ainsi que
        le <b>poids cible</b> de ce dernier dans le portefeuille choisi après validation.</p>
        <form class="form-rebalance form-horizontal">
            <input type="hidden" id="PositionCode2" name="PortfolioCode" value="" />
            <div class="form-group">
                <label class="control-label col-sm-3">Date de valeur</label>
                <div class="col-sm-9">
                    <input type="date" class="form-control" name="ValueDate" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-3">Instrument</label>
                <div class="col-sm-9">
                    <select name="SecurityID" class="form-control select-funds"></select>
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-3">Poids cible %</label>
                <div class="col-sm-9">
                    <input type="number" class="form-control text-right" min="0" max="100" name="TargetWeight" value="" placeholder="25 means 25%" />
                </div>
            </div>
            <p class="text-right">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
            </p>
            <p id="results-rebalance" class="text-info"></p>
        </form>
    </div>

</section>


<section class="container">
    <h2>Implémentation</h2>
    <p>
        Pour cette expérience, nous allons prendre une version locale des scripts de restitution afin de mieux personnaliser le
        contenu et l'ordre de la table
    </p>

    <pre class="prettyprint"><xmp>
    <!-- Latest version of d3 librairies -->
    <script src="https://lili2.am/Scripts/d3/d3.js" type="text/javascript"></script>
    <!-- Latest version of crossfilter librairies -->
    <script src="https://lili2.am/Scripts/Crossfilter/crossfilter.js" type="text/javascript"></script>
    <!-- Latest version of dc librairies -->
    <script src="https://lili2.am/Scripts/dc/2.1.7/dc.js" type="text/javascript"></script>
    </xmp></pre>
        <p>
            Pour personnaliser notre tableau comparatif, nous avons simplement fait une copie du script proposé par défaut (instrument-charts),
            script que nous avons enregistré sur notre serveur pour édition. Nous avons ici retiré quelques colonnes et redirigé certains liens.
        </p>
    <pre class="prettyprint"><xmp>
    <!-- IMPORTANT Local version of widgets activity charts -->
    <script src="~/Scripts/activity-charts.js" type="text/javascript"></script>
    </xmp></pre>
        <p>Chaque élément pour widget a une propriété <span class="atn">data-chart</span> permettant de définir le type de widget qui sera déployé au sein de l'élément.</p>
    <pre class="prettyprint"><xmp>
    <div id="pnl-counter" class="activity-chart number" data-chart="number" data-number="pnl"></div>
    <div id="rating-pie" class="portfolio-chart pie-chart" data-chart="pie" data-dimension="rating">
        ...
    </div>
    </xmp>
    </pre>

</section>


@section scripts {


    <!-- Latest version of d3 librairies -->
    <script src="https://lili2.am/Scripts/d3/d3.js" type="text/javascript"></script>
    <!-- Latest version of crossfilter librairies -->
    <script src="https://lili2.am/Scripts/Crossfilter/crossfilter.js" type="text/javascript"></script>
    <!-- Latest version of dc librairies -->
    <script src="https://lili2.am/Scripts/dc/2.1.7/dc.js" type="text/javascript"></script>
    <!-- Latest version of calculations on arrays -->
    <script src="https://lili2.am/Scripts/jquery-array-stats.js" type="text/javascript"></script>
    <!-- Local version of activity widgets -->
    <script src="~/Scripts/activity-charts.js"></script>

    <script>

        $(document).ready(function () {

            // First, we create a new instance of portfolios controller to get data from server with LILI API
            $p = new LoyolApp.PortfolioController();
            $a = new LoyolApp.AssetsController();

            // create a new instance of activityCharts from the server
            $x = new activityCharts();
            // we group all the element classed activity-chart
            $x.group($('.activity-chart'));
            
            // populate the portfolio selectors and the asset selectors
            $p.select($('.select-portfolios'));
            $a.select($('.select-funds'));

            // when select new portfolio
            $('.select-portfolios').on('change', function () {
                $('#PositionCode2').val(this.value);
            });

            // button to display portfolio historical operations
            $('.btn-activity').click(function () {
                // As option, we use here STD for 'Start To Date'; change to YTP or 1M or  ....
                var params = { code: $('#PositionCode').val(), option: $('#depth').val() };
                // Get the activity data from the server in Json format by calling the method Activity
                $p.get('activity', params, function (data) {
                    // Then we populate the widgets with data (list of JsonOperation)
                    $x.loaddata(data);
                });
            })

            // Indicator selector
            $('.btn-select .btn').click(function () {
                var chartdiv = $(this).parent().data('chart');
                $(chartdiv).data('value', $(this).data('value'));
                $x.widget(chartdiv).reload();
            });

            // When we submit for an upload a set of operations link to the current portfolio
            $('.form-rebalance').submit(function () {
                var params = $(this).serialize();
                //$('#results-balance').html('');
                $p.post('Rebalance', params, function (result) {
                    alert(result.type + ' ' + result.status + ' prix : ' + result.price);
                })
                return false;
            });

            //Listen to resize widgets (tablet or smartphone)
            window.addEventListener('widgetsLoaded', function (e) {
                window.onresize = redraw;
            });

        });

    </script>
}
